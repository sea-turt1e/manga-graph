name: Neo4j AuraDB Keep-Alive

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“18æ™‚
    - cron: '0 9 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  keepalive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Neo4j driver
      run: |
        pip install neo4j
    
    - name: Keep Neo4j AuraDB alive
      env:
        NEO4J_URI: ${{ secrets.NEO4J_URI }}
        NEO4J_USERNAME: ${{ secrets.NEO4J_USER }}
        NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
      run: |
        python << 'EOF'
        from neo4j import GraphDatabase
        import os
        import sys
        from datetime import datetime
        
        def keep_alive():
            uri = os.getenv('NEO4J_URI')
            username = os.getenv('NEO4J_USERNAME')
            password = os.getenv('NEO4J_PASSWORD')
            
            if not all([uri, username, password]):
                print("âŒ ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
                sys.exit(1)
            
            try:
                driver = GraphDatabase.driver(uri, auth=(username, password))
                
                with driver.session() as session:
                    # è»½ã„ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²ã‚’æ®‹ã™
                    result = session.run("RETURN datetime() AS current_time, 'keep-alive' AS status")
                    record = result.single()
                    
                    print(f"âœ… Neo4j AuraDB Keep-AliveæˆåŠŸ!")
                    print(f"ğŸ• æ™‚åˆ»: {record['current_time']}")
                    print(f"ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {record['status']}")
                    
                    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚‚å–å¾—ï¼ˆAuraDBå¯¾å¿œç‰ˆï¼‰
                    try:
                        # ãƒãƒ¼ãƒ‰æ•°ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—æ•°ã‚’å–å¾—
                        stats_result = session.run("""
                            MATCH (n) 
                            OPTIONAL MATCH ()-[r]->() 
                            RETURN count(DISTINCT n) AS nodes, count(DISTINCT r) AS relationships
                        """)
                        stats = stats_result.single()
                        print("ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆ:")
                        print(f"   ãƒãƒ¼ãƒ‰æ•°: {stats['nodes']}")
                        print(f"   ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—æ•°: {stats['relationships']}")
                        
                        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’å–å¾—
                        db_result = session.run("CALL db.info() YIELD name RETURN name")
                        db_name = db_result.single()
                        print(f"   ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: {db_name['name']}")
                        
                    except Exception as db_error:
                        print(f"ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—: {db_error}")
                        # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ keep-alive ã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
                
                driver.close()
                print("âœ… æ¥ç¶šã‚’æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸ")
                
            except Exception as e:
                print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                sys.exit(1)
        
        if __name__ == "__main__":
            keep_alive()
        EOF